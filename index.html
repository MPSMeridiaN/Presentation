<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control & Instrumentation (C&I) - EGAT Maintenance</title>
    
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- กำหนด Tailwind Config เพื่อเพิ่มสี EGAT Blue และ EGAT Yellow/Gold -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'egat-blue': '#004d99',   /* สีน้ำเงินเข้มหลักของ EGAT */
                        'egat-yellow': '#FFD700', /* สีเหลือง/ทอง (Accent) ของ EGAT */
                        'gemini-purple': '#5A189A', /* สีม่วงสำหรับ Gemini */
                        'solution-green': '#10b981', /* สีเขียวสำหรับเฉลย */
                    },
                }
            }
        }
    </script>

    <!-- กำหนด Font Inter และการตั้งค่าพื้นฐาน พร้อมปรับ Minimal Style -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* สีพื้นหลังอ่อนๆ เพื่อความสบายตา */
        }

        /* Custom scrollbar style (Optional but good for aesthetics) */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #999;
        }

        /* เพิ่มความโปร่งใสสำหรับการเปลี่ยนเนื้อหา (Optional, but smoother) */
        .content-section {
            transition: opacity 0.3s ease-in-out;
        }
        
        .loading-animation {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #004d99; /* EGAT Blue */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .solution-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, padding 0.4s ease-in-out;
            padding: 0 1rem; /* Adjust padding to match surrounding container */
        }

        .solution-content.active {
            max-height: 1000px; /* Large enough value */
            padding: 1rem;
        }
    </style>

</head>
<body class="antialiased">
    
    <!-- API Key and Config placeholders (Required for Canvas environment) -->
    <script>
        // These global variables are provided by the canvas environment
        const apiKey = "";
        const apiUrlBase = "https://generativelanguage.googleapis.com/v1beta/models/";
        const modelName = "gemini-2.5-flash-preview-09-2025";
    </script>


    <!-- Header Section -->
    <header class="bg-egat-blue shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-4 md:py-5 flex justify-between items-center">
            <h1 class="text-2xl md:text-3xl font-bold text-white tracking-tight">
                C&I Maintenance Team
            </h1>
            <nav id="main-nav">
                <!-- เปลี่ยนชื่อเมนูเป็นภาษาอังกฤษ -->
                <a href="#overview" data-target="overview" class="nav-link text-white hover:text-egat-yellow transition duration-300 text-sm md:text-base ml-4 hover:underline font-bold">Overview</a>
                <a href="#details" data-target="details" class="nav-link text-white hover:text-egat-yellow transition duration-300 text-sm md:text-base ml-4 hover:underline">Details</a>
                <a href="#combined_cycle" data-target="combined_cycle" class="nav-link text-white hover:text-egat-yellow transition duration-300 text-sm md:text-base ml-4 hover:underline">Combined Cycle</a>
                <!-- เมนูใหม่: Simulation -->
                <a href="#simulation" data-target="simulation" class="nav-link text-white hover:text-egat-yellow transition duration-300 text-sm md:text-base ml-4 hover:underline">Simulation</a>
            </nav>
        </div>
    </header>

    <!-- Main Content Section -->
    <main class="container mx-auto px-4 py-10 md:py-16">
        
        <!-- ========================================================================================= -->
        <!-- 1. Overview Section -->
        <!-- ... (Unchanged content for Overview) ... -->
        <!-- ========================================================================================= -->
        <section id="overview" class="content-section mb-16">
            <!-- Card Container Standard -->
            <div class="max-w-5xl mx-auto p-6 rounded-xl shadow-lg bg-white border border-gray-200">
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-egat-blue mb-2">
                        Control & Instrumentation (C&I)
                    </h2>
                    <h3 class="text-xl text-gray-700 font-medium mb-6">
                        Control & Instrumentation Maintenance Team Overview
                    </h3>
                    <p class="text-lg text-gray-600 max-w-4xl mx-auto border-b border-egat-yellow pb-4 mb-8">
                        C&I Maintenance Team คือหัวใจสำคัญในการรักษาความมั่นคงของระบบผลิตไฟฟ้า โดยรับผิดชอบดูแลและบำรุงรักษาระบบควบคุมอัตโนมัติ (DCS/PLC) และเครื่องมือวัดค่าทางกายภาพทั้งหมด เพื่อให้โรงไฟฟ้าทำงานด้วยประสิทธิภาพสูงสุดและปลอดภัยตามมาตรฐานสากล
                    </p>
                </div>

                <!-- Key Mission Points in a Grid (h4 เป็นภาษาอังกฤษ) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                    
                    <div class="p-4 rounded-lg bg-egat-blue/5 border border-egat-blue/20">
                        <!-- Icon: Check Circle -->
                        <svg class="w-8 h-8 mx-auto text-egat-blue mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">System Stability</h4>
                        <p class="text-sm text-gray-600">รับประกันความต่อเนื่องในการควบคุมกระบวนการผลิตไฟฟ้า</p>
                    </div>

                    <div class="p-4 rounded-lg bg-egat-blue/5 border border-egat-blue/20">
                        <!-- Icon: Tachometer (for efficiency/speed) -->
                        <svg class="w-8 h-8 mx-auto text-egat-blue mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">Maximum Efficiency</h4>
                        <p class="text-sm text-gray-600">การสอบเทียบและบำรุงรักษาเชิงรุกเพื่อลดการสูญเสียพลังงาน</p>
                    </div>

                    <div class="p-4 rounded-lg bg-egat-blue/5 border border-egat-blue/20">
                        <!-- Icon: Shield Check (for Reliability and Safety Assurance) -->
                        <svg class="w-8 h-8 mx-auto text-egat-blue mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <!-- Shield Shape -->
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                            <!-- Checkmark inside -->
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4" />
                        </svg>
                        <h4 class="font-semibold text-lg text-gray-800 mb-1">Reliability & Safety</h4>
                        <p class="text-sm text-gray-600">ดูแลระบบ SIS และอุปกรณ์ป้องกันอันตรายให้พร้อมใช้งานเสมอ</p>
                    </div>
                </div>
            </div>
        </section>


        <!-- ========================================================================================= -->
        <!-- 2. Detail Cards Section -->
        <!-- ... (Unchanged content for Details) ... -->
        <!-- ========================================================================================= -->
        <section id="details" class="content-section hidden mb-16">
            <!-- Card Container Standard -->
            <div class="max-w-5xl mx-auto p-6 rounded-xl shadow-lg bg-white border border-gray-200">
                
                <h2 class="text-3xl md:text-4xl font-extrabold text-egat-blue mb-2 text-center">
                    Work Details
                </h2>
                <p class="text-lg text-gray-600 max-w-4xl mx-auto border-b border-egat-yellow pb-4 mb-8 text-center">
                    คลิกที่หัวข้อด้านล่างเพื่อดูรายละเอียดเชิงลึกเกี่ยวกับขอบเขตความรับผิดชอบและหน้าที่หลักของทีม C&I
                </p>

                <!-- Detail Cards Grid (h3 เป็นภาษาอังกฤษ) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">

                    <!-- Card 1: Introduction -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="intro">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">📝</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Introduction & Organizational Structure</h3>
                        <p class="text-gray-500 text-sm">ทำความรู้จักกับ C&I และบทบาทสำคัญในองค์กร</p>
                    </div>

                    <!-- Card 2: Core Work -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="core_work">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">🛠️</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Core C&I Functions</h3>
                        <p class="text-gray-500 text-sm">แยกประเภทงานควบคุมและงานเครื่องมือวัด</p>
                    </div>

                    <!-- Card 3: System Overview -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="system_overview">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">⚙️</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Control & Instrumentation Systems</h3>
                        <p class="text-gray-500 text-sm">ส่วนประกอบและเทคโนโลยีหลักที่ใช้งาน</p>
                    </div>

                    <!-- Card 4: Maintenance -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="maintenance">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">🔧</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Maintenance and Repair</h3>
                        <p class="text-gray-500 text-sm">แนวทางการบำรุงรักษาและการสอบเทียบ</p>
                    </div>

                    <!-- Card 5: Safety & Compliance -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="safety">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">🛡️</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Safety and Compliance</h3>
                        <p class="text-gray-500 text-sm">มาตรฐานความปลอดภัยและข้อบังคับที่เกี่ยวข้อง</p>
                    </div>

                    <!-- Card 6: Technology & Future -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="future">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">💡</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Technology and Future</h3>
                        <p class="text-gray-500 text-sm">แนวโน้มการเปลี่ยนแปลงและเทคโนโลยีใหม่</p>
                    </div>

                </div>
            </div>
        </section>
        
        <!-- ========================================================================================= -->
        <!-- 3. Combined Cycle Section: เพิ่ม Detail Cards สำหรับเนื้อหาเชิงลึก -->
        <!-- ... (Unchanged content for Combined Cycle) ... -->
        <!-- ========================================================================================= -->
        <section id="combined_cycle" class="content-section hidden mb-16">
            <!-- Card Container Standard -->
            <div class="max-w-5xl mx-auto p-6 rounded-xl shadow-lg bg-white border border-gray-200">
                
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-egat-blue mb-2">
                        Combined Cycle Power Plant
                    </h2>
                    <p class="text-lg text-gray-600 max-w-4xl mx-auto border-b border-egat-yellow pb-4 mb-8">
                        โรงไฟฟ้าพลังความร้อนร่วมใช้เทคโนโลยีการผลิตไฟฟ้าแบบ 2 วัฏจักร (Cycle) เพื่อเพิ่มประสิทธิภาพในการผลิตไฟฟ้าสูงสุด
                    </p>
                </div>

                <!-- Foundation and Cycle Overview (h3/h4 เป็นภาษาอังกฤษ) -->
                <div class="mb-10 p-6 bg-egat-blue/5 rounded-lg border border-egat-blue/10">
                    <h3 class="text-2xl font-bold text-egat-blue mb-3 text-center">Fundamental Principles and Operating Cycles</h3>
                    <p class="text-gray-700 mb-4 text-center">Combined Cycle คือการรวม **วัฏจักรเบรย์ตัน (Brayton Cycle)** จากกังหันก๊าซ เข้ากับ **วัฏจักรแรงคิน (Rankine Cycle)** จากกังหันไอน้ำ เพื่อนำความร้อนเหลือทิ้งมาใช้ซ้ำ</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-100">
                            <h4 class="font-semibold text-xl text-gray-800 mb-1 flex items-center">
                                <span class="text-egat-yellow text-2xl mr-2">1.</span> Brayton Cycle (Gas Turbine)
                            </h4>
                            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                                <li><strong>การผลิต:</strong> เผาไหม้ก๊าซเพื่อขับกังหัน (Gas Turbine) ผลิตไฟฟ้ารอบแรก</li>
                                <li><strong>ผลลัพธ์:</strong> ได้ก๊าซร้อน (ประมาณ 550 - 650°C) ซึ่งถูกส่งต่อไปยัง HRSG</li>
                            </ul>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow-sm border border-gray-100">
                            <h4 class="font-semibold text-xl text-gray-800 mb-1 flex items-center">
                                <span class="text-egat-yellow text-2xl mr-2">2.</span> Rankine Cycle (Steam Turbine)
                            </h4>
                            <ul class="list-disc pl-5 text-sm text-gray-600 space-y-1">
                                <li><strong>การผลิต:</strong> นำความร้อนจากก๊าซไอเสียมาผลิตไอน้ำแรงดันสูง (HRSG)</li>
                                <li><strong>ผลลัพธ์:</strong> ไอน้ำขับกังหันไอน้ำ (Steam Turbine) ผลิตไฟฟ้ารอบที่สอง</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- NEW: C&I Detail Cards for Combined Cycle (h3 เป็นภาษาอังกฤษ) -->
                <h3 class="text-2xl font-bold text-egat-blue mb-4 text-center border-b border-gray-200 pb-2">In-Depth Details (Click for C&I Role)</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    
                    <!-- Card CC-1: Gas Turbine & Combustion -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="cc_gasturbine">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">🔥</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Gas Turbine (GT) and Combustion</h3>
                        <p class="text-gray-500 text-sm">การควบคุมอุณหภูมิ, เชื้อเพลิง, และระบบป้องกันอันตราย</p>
                    </div>

                    <!-- Card CC-2: HRSG & Water/Steam -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="cc_hrsg">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">♨️</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">HRSG (Heat Recovery Steam Generator)</h3>
                        <p class="text-gray-500 text-sm">การควบคุมแรงดัน, อุณหภูมิไอน้ำ, และระดับน้ำ</p>
                    </div>

                    <!-- Card CC-3: Steam Turbine & BOP -->
                    <div class="detail-card bg-gray-50 p-8 rounded-xl shadow-md hover:shadow-xl transition duration-300 cursor-pointer hover:ring-2 hover:ring-egat-blue" data-detail="cc_steamturbine">
                        <div class="flex items-center justify-between mb-3">
                            <span class="text-4xl text-egat-blue">💧</span>
                        </div>
                        <h3 class="text-xl font-semibold text-egat-blue mb-1">Steam Turbine (ST) and Balance of Plant (BOP)</h3>
                        <p class="text-gray-500 text-sm">การควบคุมการทำงานของ ST, คอนเดนเซอร์, และปั๊ม</p>
                    </div>

                </div>
                
                <!-- C&I Roles Grid (h3/h4 เป็นภาษาอังกฤษ) -->
                <div class="mt-12">
                    <h3 class="text-2xl font-bold text-egat-blue mb-4 text-center border-b border-gray-200 pb-2">Central Control Systems</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-center">
                        <div class="p-4 rounded-lg bg-gray-50 border border-egat-blue/20">
                            <h4 class="font-semibold text-lg text-gray-800">DCS</h4>
                            <p class="text-sm text-gray-600">ควบคุมรวมทั้งหมด</p>
                        </div>
                        <div class="p-4 rounded-lg bg-gray-50 border border-egat-blue/20">
                            <h4 class="font-semibold text-lg text-gray-800">BMS</h4>
                            <p class="text-sm text-gray-600">จัดการการจุดระเบิด</p>
                        </div>
                        <div class="p-4 rounded-lg bg-gray-50 border border-egat-blue/20">
                            <h4 class="font-semibold text-lg text-gray-800">Vibration System</h4>
                            <p class="text-sm text-gray-600">ตรวจจับการสั่น</p>
                        </div>
                        <div class="p-4 rounded-lg bg-gray-50 border border-egat-blue/20">
                            <h4 class="font-semibold text-lg text-gray-800">CEMS</h4>
                            <p class="text-sm text-gray-600">ตรวจสอบมลพิษ</p>
                        </div>
                    </div>
                </div>

            </div>
        </section>
        
        <!-- ========================================================================================= -->
        <!-- 4. Simulation Section (New) -->
        <!-- ========================================================================================= -->
        <section id="simulation" class="content-section hidden mb-16">
            <!-- Card Container Standard -->
            <div class="max-w-5xl mx-auto p-6 rounded-xl shadow-lg bg-white border border-gray-200">
                
                <div class="text-center">
                    <h2 class="text-3xl md:text-4xl font-extrabold text-egat-blue mb-2">
                        Simulation Scenario Generator ✨
                    </h2>
                    <p class="text-lg text-gray-600 max-w-4xl mx-auto border-b border-egat-yellow pb-4 mb-8">
                        ใช้ AI ในการสร้างสถานการณ์การฝึกซ้อมการซ่อมบำรุง C&I ที่ซับซ้อนและสมจริงสำหรับทีมงานของคุณ!
                    </p>
                </div>

                <div class="flex flex-col items-center space-y-4 mb-8">
                    <button 
                        id="generate-scenario-btn" 
                        onclick="generateSimulationIdea()"
                        class="px-8 py-3 bg-gemini-purple text-white font-bold rounded-full shadow-lg hover:bg-gemini-purple/90 transition duration-300 transform hover:scale-[1.02] active:scale-95 flex items-center justify-center disabled:opacity-50"
                    >
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zm-5 8a5 5 0 0110 0h-2a3 3 0 10-6 0H5z"></path></svg>
                        สร้างสถานการณ์จำลอง (Complex Scenario)
                    </button>
                    <div id="simulation-loading" class="hidden flex items-center text-egat-blue">
                        <div class="loading-animation mr-3"></div>
                        กำลังสร้างสถานการณ์... โปรดรอสักครู่
                    </div>
                </div>

                <!-- Result Display Area -->
                <div id="simulation-result-container" class="mt-8 border border-gray-200 rounded-xl p-6 bg-white shadow-inner min-h-[150px]">
                    <h3 class="text-xl font-semibold text-gray-800 mb-3 border-b pb-2">สถานการณ์การฝึกซ้อมที่สร้างโดย AI:</h3>
                    <div id="simulation-result" class="text-gray-700 whitespace-pre-wrap">
                        คลิกปุ่มด้านบนเพื่อสร้างสถานการณ์การซ่อมบำรุง C&I แบบสมจริงสำหรับโรงไฟฟ้าพลังความร้อนร่วม
                    </div>
                </div>
            </div>
        </section>


    </main>

    <!-- Modal Structure (Hidden by default) -->
    <div id="modal" class="hidden fixed inset-0 z-40">
        <!-- Backdrop -->
        <div id="modal-backdrop" class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity duration-300 opacity-0"></div>

        <!-- Modal Content -->
        <div id="modal-content-box" class="fixed inset-0 flex items-center justify-center p-4 transition-transform duration-300 scale-95 opacity-0">
            <div class="modal-content bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto relative p-8">
                
                <h3 id="modal-title" class="text-3xl font-bold text-egat-blue mb-4 border-b pb-2"></h3>
                
                <!-- Main Detail Content -->
                <div id="modal-body" class="text-gray-700 space-y-4">
                    <!-- Detail content will be injected here -->
                </div>
                
                <!-- Divider for AI Section -->
                <hr class="my-6 border-t border-gray-200">

                <!-- AI Technical Assistant Section (NEW) -->
                <div class="mt-6 p-4 bg-gemini-purple/5 rounded-xl border border-gemini-purple/10">
                    <h4 class="text-xl font-semibold text-gemini-purple mb-3 flex items-center">
                        ✨ AI Technical Assistant (ถามข้อมูลเพิ่มเติม)
                    </h4>
                    
                    <input type="text" id="ai-question-input" placeholder="พิมพ์คำถามทางเทคนิคเพิ่มเติมเกี่ยวกับหัวข้อนี้ (เช่น 'Calibration frequency for flow transmitters?')" 
                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-egat-blue focus:border-egat-blue transition duration-150 mb-3">
                    
                    <button 
                        id="ask-ai-btn" 
                        onclick="askAIAssistant()" 
                        class="px-4 py-2 bg-egat-blue text-white font-semibold rounded-lg shadow-md hover:bg-egat-blue/90 transition duration-300 disabled:opacity-50"
                        disabled
                    >
                        ค้นหาคำตอบด้วย AI
                    </button>

                    <!-- AI Response Area -->
                    <div id="ai-response-container" class="mt-4 hidden">
                        <div id="ai-loading" class="hidden flex items-center text-gemini-purple">
                            <div class="loading-animation mr-3"></div>
                            กำลังค้นหาคำตอบ...
                        </div>
                        <div id="ai-answer" class="p-3 bg-white border border-gemini-purple/20 rounded-lg text-gray-700">
                            <!-- AI response will be injected here -->
                        </div>
                        <div id="ai-sources" class="mt-2 text-xs text-gray-500">
                            <!-- Sources will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- Close Button -->
                <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 transition duration-300">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
                </button>

            </div>
        </div>
    </div>


    <!-- Detail Content Definitions (Hidden) -->
    <div class="hidden">
        
        <!-- Detail 1: Introduction (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-intro">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Introduction and Organizational Structure</h3>
            <span id="detail-topic-intro" class="hidden">Organizational Structure and Key Responsibilities of C&I Team in Power Plant</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Background and Evolution</h4>
                <p class="text-gray-600">งาน C&I เริ่มต้นขึ้นพร้อมกับการพัฒนาโรงไฟฟ้าของ กฟผ. โดยมีวิวัฒนาการจากการควบคุมแบบอะนาล็อกไปสู่ระบบดิจิทัลที่ซับซ้อนในปัจจุบัน</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Mission and Significance</h4>
                <p class="text-gray-600">มุ่งเน้นการบำรุงรักษาระบบควบคุมและเครื่องมือวัดให้อยู่ในสภาพพร้อมใช้งานสูงสุด เพื่อสนับสนุนการผลิตไฟฟ้าที่มั่นคงและมีประสิทธิภาพ.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Team Structure</h4>
                <p class="text-gray-600">แบ่งออกเป็นหน่วยงานย่อยตามลักษณะของระบบ เช่น ระบบควบคุมหลัก (DCS), ระบบความปลอดภัย, และงานสอบเทียบเครื่องมือวัด.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Key Team Responsibilities</h4>
                <ul class="list-disc pl-5 space-y-1 text-gray-600">
                    <li>วางแผนและดำเนินการบำรุงรักษาเชิงป้องกัน (PM)</li>
                    <li>วิเคราะห์และแก้ไขปัญหาที่เกิดขึ้นกับระบบควบคุม</li>
                    <li>บริหารจัดการอะไหล่และเอกสารทางเทคนิค</li>
                </ul>
            </section>
        </div>

        <!-- Detail 2: Core Work (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-core_work">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Core C&I Functions</h3>
             <span id="detail-topic-core_work" class="hidden">DCS and PLC maintenance in power generation.</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Primary Control Systems (DCS/PLC)</h4>
                <p class="text-gray-600">การดูแลรักษาและปรับปรุงระบบควบคุมอัตโนมัติ เช่น DCS (Distributed Control System) และ PLC (Programmable Logic Controller) เพื่อควบคุมกระบวนการผลิตไฟฟ้า.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Instrumentation and Sensors</h4>
                <p class="text-gray-600">การติดตั้ง บำรุงรักษา และสอบเทียบเครื่องมือวัดต่างๆ เช่น เครื่องวัดอุณหภูมิ ความดัน อัตราการไหล และระดับ เพื่อให้การวัดค่ามีความแม่นยำ.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Specialized Work and Technology</h4>
                <p class="text-gray-600">รวมถึงงานที่เกี่ยวข้องกับระบบความปลอดภัย (Safety Instrumented Systems - SIS), ระบบตรวจจับเพลิงไหม้ (Fire and Gas), และระบบควบคุมกังหัน (Turbine Control Systems).</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Technical Documentation Management</h4>
                <p class="text-gray-600">การจัดทำ จัดเก็บ และปรับปรุงแบบแปลน (Drawings), คู่มือ (Manuals), และประวัติการซ่อมบำรุง (Maintenance Records) เพื่อให้พร้อมสำหรับการอ้างอิงและตรวจสอบ.</p>
            </section>
        </div>

        <!-- Detail 3: System Overview (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-system_overview">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Control and Instrumentation Systems</h3>
             <span id="detail-topic-system_overview" class="hidden">Power Plant Control Systems (DCS/PLC, Sensors, and Safety Systems)</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Primary Control Systems (DCS/PLC)</h4>
                <p class="text-gray-600">เป็นหัวใจสำคัญในการสั่งการและควบคุมการทำงานของอุปกรณ์ในโรงไฟฟ้า หน้าที่หลักคือการเฝ้าระวังและการตอบสนองต่อการเปลี่ยนแปลงของกระบวนการ.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Sensors and Transducers</h4>
                <p class="text-gray-600">อุปกรณ์ที่แปลงค่าทางกายภาพ (เช่น ความร้อน, แรงดัน) ให้เป็นสัญญาณไฟฟ้า เพื่อส่งไปยังระบบควบคุม.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Safety Systems</h4>
                <p class="text-gray-600">ระบบที่ออกแบบมาเพื่อป้องกันความเสียหายต่ออุปกรณ์ บุคลากร และสิ่งแวดล้อม เช่น ระบบ ESD (Emergency Shutdown).</p>
            </section>
        </div>
        
        <!-- Detail 4: Maintenance (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-maintenance">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Maintenance and Repair</h3>
            <span id="detail-topic-maintenance" class="hidden">Preventive and Corrective Maintenance for C&I systems including calibration standards</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Preventive Maintenance (PM)</h4>
                <p class="text-gray-600">การดำเนินการตามแผนเพื่อป้องกันความล้มเหลวของอุปกรณ์ เช่น การเปลี่ยนแบตเตอรี่, การทำความสะอาดตู้ควบคุม, และการตรวจสอบสายสัญญาณ.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Corrective Maintenance (CM)</h4>
                <p class="text-gray-600">การซ่อมแซมทันทีเมื่อเกิดความผิดปกติหรือความล้มเหลวของระบบ เพื่อให้ระบบกลับมาทำงานได้ตามปกติ.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Calibration and Standards</h4>
                <p class="text-gray-600">การสอบเทียบเครื่องมือวัดตามมาตรฐานสากล (เช่น ISO/IEC 17025) และการเก็บบันทึกประวัติการสอบเทียบอย่างเป็นระบบ.</p>
            </section>
            
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Spares and Tool Management</h4>
                <p class="text-gray-600">การสำรองอะไหล่สำคัญ (Critical Spares) อย่างเหมาะสม และการดูแลรักษาเครื่องมือสอบเทียบและเครื่องมือเฉพาะทางให้อยู่ในสภาพพร้อมใช้งาน.</p>
            </section>
        </div>

        <!-- Detail 5: Safety & Compliance (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-safety">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Safety and Compliance</h3>
            <span id="detail-topic-safety" class="hidden">Safety standards, compliance, and risk management for C&I systems (e.g., IEC 61511)</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Standards and Regulations</h4>
                <p class="text-gray-600">การปฏิบัติตามมาตรฐาน IEC 61511 (Safety Instrumented Systems) และข้อกำหนดอื่นๆ ที่เกี่ยวข้องกับการทำงานในพื้นที่เสี่ยง (Hazardous Areas).</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Training and Certification</h4>
                <p class="text-gray-600">บุคลากร C&I ต้องได้รับการฝึกอบรมเฉพาะทางด้านเทคนิค ความปลอดภัย และการทำงานกับระบบไฟฟ้า/ควบคุมแรงดันสูง.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Risk Management</h4>
                <p class="text-gray-600">การประเมินความเสี่ยงและวางแผนบรรเทาความเสี่ยงที่เกี่ยวข้องกับการทำงานผิดพลาดของระบบควบคุมซึ่งอาจส่งผลกระทบต่อการผลิตและความปลอดภัย.</p>
            </section>
        </div>

        <!-- Detail 6: Technology & Future (h3/h4 เป็นภาษาอังกฤษ) -->
        <div id="detail-content-future">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Technology and Future</h3>
            <span id="detail-topic-future" class="hidden">Digital Transformation, Cybersecurity, and future trends in C&I maintenance</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Digital Transformation and Industry 4.0</h4>
                <p class="text-gray-600">การนำเทคโนโลยี IoT, Cloud Computing และ AI มาใช้ในการวิเคราะห์ข้อมูลการทำงานของ C&I เพื่อการบำรุงรักษาเชิงคาดการณ์ (Predictive Maintenance).</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Cybersecurity</h4>
                <p class="text-gray-600">การป้องกันระบบควบคุมอุตสาหกรรม (ICS) จากภัยคุกคามทางไซเบอร์ ซึ่งเป็นสิ่งสำคัญอย่างยิ่งในยุคดิจิทัล.</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Future Trends</h4>
                <p class="text-gray-600">การเปลี่ยนไปใช้เครื่องมือวัดไร้สาย (Wireless Instrumentation) และการบูรณาการระบบควบคุมจากผู้ผลิตที่หลากหลาย (Vendor Neutral Systems).</p>
            </section>
        </div>
        
        <!-- ========================================================================================= -->
        <!-- CC Detail 1: Gas Turbine & Combustion (h3/h4 เป็นภาษาอังกฤษ) -->
        <!-- ========================================================================================= -->
        <div id="detail-content-cc_gasturbine">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Gas Turbine (GT) and Combustion</h3>
            <span id="detail-topic-cc_gasturbine" class="hidden">Gas Turbine and Combustion control systems in combined cycle power plants</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">GT Principles and Cycle</h4>
                <p class="text-gray-600">อากาศถูกอัดโดยคอมเพรสเซอร์ (Compressor) ผสมกับเชื้อเพลิงในห้องเผาไหม้ (Combustion Chamber) และก๊าซร้อนที่ได้จะขับเคลื่อนกังหัน (Turbine) เพื่อผลิตไฟฟ้าตามวัฏจักร Brayton การควบคุมอุณหภูมิที่เข้าและออกจากกังหันมีความสำคัญสูงสุดต่ออายุการใช้งาน</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Role: Control and Protection</h4>
                <ul class="list-disc pl-5 space-y-1 text-gray-600">
                    <li>**Turbine Control System (TCS):** ควบคุมความเร็ว, โหลด (Load), และอุณหภูมิไอเสีย (Exhaust Temperature) อย่างต่อเนื่อง</li>
                    <li>**Protection System:** รับผิดชอบระบบป้องกันอันตรายจากการสั่นสะเทือน (Vibration), ความเร็วเกิน (Overspeed), และอุณหภูมิสูงเกิน</li>
                    <li>**Flame Monitoring:** ติดตั้งและสอบเทียบ UV/IR Detector เพื่อตรวจสอบความเสถียรของการเผาไหม้ (Flame Stability)</li>
                </ul>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Challenges</h4>
                <p class="text-gray-600">การสอบเทียบเทอร์โมคัปเปิล (Thermocouple) ที่วัดอุณหภูมิในห้องเผาไหม้ที่มีความแม่นยำสูง และการปรับแต่งระบบควบคุมเชื้อเพลิงเพื่อลดการปล่อย NOx/CO ภายใต้การเปลี่ยนแปลงโหลด</p>
            </section>
        </div>
        
        <!-- ========================================================================================= -->
        <!-- CC Detail 2: HRSG & Water/Steam (h3/h4 เป็นภาษาอังกฤษ) -->
        <!-- ========================================================================================= -->
        <div id="detail-content-cc_hrsg">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">HRSG (Heat Recovery Steam Generator)</h3>
            <span id="detail-topic-cc_hrsg" class="hidden">Heat Recovery Steam Generator (HRSG) C&I systems and 3-Element Drum Level Control</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">HRSG Principles and Steam Generation</h4>
                <p class="text-gray-600">HRSG ใช้ก๊าซไอเสียร้อนจาก GT มาเปลี่ยนน้ำให้เป็นไอน้ำแรงดันสูง, กลาง, และต่ำ เพื่อขับ Steam Turbine โดยไม่ใช้เชื้อเพลิงเพิ่มเติม ทำให้ประสิทธิภาพโดยรวมของโรงไฟฟ้าเพิ่มขึ้นอย่างมาก</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Role: Level and Temperature Control</h4>
                <ul class="list-disc pl-5 space-y-1 text-gray-600">
                    <li>**Drum Level Control:** รับผิดชอบระบบควบคุมระดับน้ำในหม้อไอน้ำ (Drum) แบบ 3-Element Control ซึ่งมีความสำคัญต่อความปลอดภัยสูงสุด</li>
                    <li>**Temperature Control:** ควบคุมอุณหภูมิไอน้ำออก (Superheat/Reheat Temperature) โดยใช้ Desuperheater (Spray Water Control) เพื่อป้องกันความเสียหายต่อ ST</li>
                    <li>**Pressure Control:** ควบคุมแรงดันไอน้ำในแต่ละระดับ (HP, IP, LP) และป้องกันแรงดันเกิน</li>
                </ul>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Challenges</h4>
                <p class="text-gray-600">ความผันผวนของระดับน้ำใน Drum ระหว่างการ Start-up/Shutdown (Shrinkage/Swell) และการสอบเทียบเครื่องมือวัดอัตราการไหล (Flow meters) รวมถึงการบำรุงรักษา Actuator วาล์วที่ทำงานภายใต้อุณหภูมิสูง</p>
            </section>
        </div>
        
        <!-- ========================================================================================= -->
        <!-- CC Detail 3: Steam Turbine & BOP (h3/h4 เป็นภาษาอังกฤษ) -->
        <!-- ========================================================================================= -->
        <div id="detail-content-cc_steamturbine">
            <h3 class="text-2xl font-bold text-egat-blue mb-4">Steam Turbine (ST) and Balance of Plant (BOP)</h3>
            <span id="detail-topic-cc_steamturbine" class="hidden">Steam Turbine, BOP, and Vibration Monitoring C&I systems in combined cycle power plants</span>
            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">Steam Turbine Operating Principles</h4>
                <p class="text-gray-600">ไอน้ำแรงดันสูงจาก HRSG ถูกส่งเข้าขับ ST เพื่อผลิตไฟฟ้ารอบสอง ไอน้ำที่ใช้งานแล้วจะถูกควบแน่นในคอนเดนเซอร์ (Condenser) กลับเป็นน้ำป้อนหม้อไอน้ำ</p>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Role: Monitoring and Protection</h4>
                <ul class="list-disc pl-5 space-y-1 text-gray-600">
                    <li>**Valve Control:** ควบคุมวาล์วควบคุมหลัก (Governor Valve) และวาล์วฉุกเฉิน (Stop Valve) ที่ใช้ในการ Start-up/Shutdown และควบคุมโหลด</li>
                    <li>**Vibration & Rotor Position Monitoring:** ดูแลระบบ Proximity Probe สำหรับเฝ้าระวังการสั่นสะเทือน (Vibration) และการเคลื่อนที่ตามแนวแกน (Axial Shift) ของโรเตอร์</li>
                    <li>**Condenser Vacuum Control:** รักษาและควบคุมสุญญากาศในคอนเดนเซอร์ ซึ่งส่งผลโดยตรงต่อประสิทธิภาพ ST</li>
                    <li>**BOP System Control:** ควบคุมการทำงานของปั๊มน้ำป้อน (Boiler Feed Pump), พัดลมระบายความร้อน (Cooling Tower Fan), และอุปกรณ์ประกอบอื่นๆ</li>
                </ul>
            </section>

            <section class="mb-6">
                <h4 class="text-lg font-semibold text-gray-700 mt-4 mb-2">C&I Challenges</h4>
                <p class="text-gray-600">การติดตั้งและการสอบเทียบ Proximity Probe และ Accelerometer ที่มีความละเอียดอ่อนสูง การดูแลระบบสุญญากาศที่ต้องการความแม่นยำของเครื่องมือวัดแรงดันสัมบูรณ์ (Absolute Pressure) และความซับซ้อนของวงจรน้ำ/ไอน้ำ</p>
            </section>
        </div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t border-gray-200 mt-12">
        <div class="container mx-auto px-4 py-6 text-center text-sm text-gray-500">
            &copy; 2024 C&I Maintenance Team. All rights reserved.
        </div>
    </footer>

    <!-- JavaScript for Modal and Content Switching Functionality & Gemini API Calls -->
    <script>
        const modal = document.getElementById('modal');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const modalContentBox = document.getElementById('modal-content-box');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        // New Gemini Elements
        const aiQuestionInput = document.getElementById('ai-question-input');
        const askAiBtn = document.getElementById('ask-ai-btn');
        const aiResponseContainer = document.getElementById('ai-response-container');
        const aiLoading = document.getElementById('ai-loading');
        const aiAnswer = document.getElementById('ai-answer');
        const aiSources = document.getElementById('ai-sources');
        
        const simulationResultContainer = document.getElementById('simulation-result-container');
        const simulationResult = document.getElementById('simulation-result');
        const generateScenarioBtn = document.getElementById('generate-scenario-btn');
        const simulationLoading = document.getElementById('simulation-loading');

        // Global variable to store the current detail's English topic for AI grounding
        let currentDetailTopic = '';

        // --- Helper Function for Gemini API Calls with Exponential Backoff ---
        async function callGeminiAPI(endpoint, payload, retries = 3, delay = 1000) {
            const apiUrl = `${apiUrlBase}${endpoint}?key=${apiKey}`;
            const headers = { 'Content-Type': 'application/json' };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    }
                    
                    if (response.status === 429 && i < retries - 1) { // Too Many Requests
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                        continue;
                    }

                    throw new Error(`API call failed with status: ${response.statusText}`);
                } catch (error) {
                    if (i === retries - 1) {
                        console.error("Gemini API call failed after all retries:", error);
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
        }
        
        // --- Feature 1: AI Technical Assistant (In Modal) ---
        async function askAIAssistant() {
            const userQuestion = aiQuestionInput.value.trim();
            if (!userQuestion || !currentDetailTopic) return;

            // 1. Set Loading State
            askAiBtn.disabled = true;
            aiResponseContainer.classList.remove('hidden');
            aiLoading.classList.remove('hidden');
            aiAnswer.innerHTML = '';
            aiSources.innerHTML = '';
            aiAnswer.classList.remove('p-3'); 

            const systemPrompt = `You are a concise technical assistant for an electrical power plant's Control & Instrumentation (C&I) team. Your goal is to answer technical questions related to the provided topic based on your knowledge and Google Search results. Keep the answer to a maximum of 4 sentences and cite all sources. The current topic is: ${currentDetailTopic}`;
            const userQuery = `User question: ${userQuestion}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiAPI(`${modelName}:generateContent`, payload);
                
                const candidate = result.candidates?.[0];
                let responseText = 'ไม่พบคำตอบที่เหมาะสมในขณะนี้';
                let sourcesHtml = '';

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    responseText = candidate.content.parts[0].text;
                    aiAnswer.classList.add('p-3'); 

                    // Extract grounding sources
                    const groundingMetadata = candidate.groundingMetadata;
                    let sources = [];
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    
                    if (sources.length > 0) {
                        sourcesHtml = '<strong class="text-gemini-purple">แหล่งข้อมูล:</strong><ul class="list-disc pl-5 mt-1">';
                        sources.forEach((s, index) => {
                            sourcesHtml += `<li><a href="${s.uri}" target="_blank" class="text-blue-500 hover:underline">${s.title}</a></li>`;
                        });
                        sourcesHtml += '</ul>';
                    }
                }
                
                aiAnswer.innerHTML = responseText;
                aiSources.innerHTML = sourcesHtml;

            } catch (error) {
                aiAnswer.innerHTML = 'เกิดข้อผิดพลาดในการเรียกใช้ AI Technical Assistant กรุณาลองใหม่อีกครั้ง';
                console.error("Error in askAIAssistant:", error);
            } finally {
                aiLoading.classList.add('hidden');
                askAiBtn.disabled = false;
            }
        }
        
        // --- Feature 2: Simulation Scenario Generator (In Simulation Tab) ---
        
        // Function to toggle the visibility of the solution
        function toggleSolution() {
            const content = document.getElementById('solution-content');
            const button = document.getElementById('toggle-solution-btn');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                button.textContent = 'แสดง แนวทางการแก้ไข (สำหรับผู้ฝึกสอน)';
            } else {
                content.classList.add('active');
                button.textContent = 'ซ่อน แนวทางการแก้ไข';
            }
        }

        // Function to generate and render the simulation idea
        async function generateSimulationIdea() {
            // 1. Set Loading State
            generateScenarioBtn.disabled = true;
            simulationLoading.classList.remove('hidden');
            simulationResult.innerHTML = '<div class="text-center py-4">กำลังสร้างสถานการณ์การฝึกซ้อมที่ซับซ้อน...</div>';
            simulationResultContainer.classList.add('shadow-xl');

            const systemPrompt = "You are a professional C&I training coordinator. Generate a single, highly realistic, complex C&I maintenance simulation scenario for a combined cycle power plant, suitable for team training. The response MUST be a JSON object with the following fields and must contain rich, detailed content in Thai for each field. Ensure the scenario is realistic for a combined cycle power plant (Gas Turbine, HRSG, Steam Turbine).";
            const userQuery = "Generate a complex, realistic C&I maintenance simulation scenario for a combined cycle training exercise.";
            
            // Define JSON Schema
            const schema = {
                type: "OBJECT",
                properties: {
                    scenarioTitle: { type: "STRING", description: "หัวข้อสถานการณ์: ชื่อสถานการณ์จำลองที่น่าดึงดูดใจ" },
                    primaryEvent: { type: "STRING", description: "เหตุการณ์หลัก: ปัญหา C&I หลักที่เกิดขึ้น" },
                    compoundingEffects: { type: "STRING", description: "ผลกระทบต่อเนื่อง: ปัญหาเสริมที่ทำให้สถานการณ์ซับซ้อนขึ้น" },
                    teamObjective: { type: "STRING", description: "เป้าหมายของทีม: สิ่งที่ทีมต้องทำเพื่อแก้ไขปัญหาหลักและผลกระทบต่อเนื่อง" },
                    requiredTools: { type: "STRING", description: "เครื่องมือ C&I ที่จำเป็น: รายการเครื่องมือเฉพาะที่ต้องใช้ในการปฏิบัติงาน" },
                    solutionKeyActions: { type: "STRING", description: "แนวทางการแก้ไข (สำหรับผู้ฝึกสอน): ลำดับขั้นตอนการแก้ไขที่ถูกต้องและผลลัพธ์ที่คาดหวัง" }
                },
                required: ["scenarioTitle", "primaryEvent", "compoundingEffects", "teamObjective", "requiredTools", "solutionKeyActions"],
                propertyOrdering: ["scenarioTitle", "primaryEvent", "compoundingEffects", "teamObjective", "requiredTools", "solutionKeyActions"]
            };

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            try {
                const result = await callGeminiAPI(`${modelName}:generateContent`, payload);
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) throw new Error("AI returned empty JSON content.");

                const scenarioData = JSON.parse(jsonText);
                
                // --- Render the Scenario ---
                const renderHTML = `
                    <div class="space-y-4">
                        <h4 class="text-2xl font-bold text-gemini-purple">${scenarioData.scenarioTitle}</h4>
                        
                        <!-- Primary Event & Compounding Effects -->
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <p class="font-semibold text-red-700">เหตุการณ์หลัก (Primary Event):</p>
                            <p class="text-gray-800">${scenarioData.primaryEvent}</p>
                        </div>
                        <div class="p-4 bg-orange-50 border border-orange-200 rounded-lg">
                            <p class="font-semibold text-orange-700">ผลกระทบต่อเนื่อง (Compounding Effects):</p>
                            <p class="text-gray-800">${scenarioData.compoundingEffects}</p>
                        </div>

                        <!-- Objective & Tools -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-egat-blue/5 border border-egat-blue/20 rounded-lg">
                                <p class="font-semibold text-egat-blue">เป้าหมายของทีม (Team Objective):</p>
                                <p class="text-gray-800">${scenarioData.teamObjective}</p>
                            </div>
                            <div class="p-4 bg-egat-blue/5 border border-egat-blue/20 rounded-lg">
                                <p class="font-semibold text-egat-blue">เครื่องมือ C&I ที่จำเป็น (Required C&I Tools):</p>
                                <p class="text-gray-800">${scenarioData.requiredTools}</p>
                            </div>
                        </div>

                        <!-- Solution/Answer Section (Hidden) -->
                        <div class="mt-6 pt-4 border-t border-gray-200">
                            <button 
                                id="toggle-solution-btn" 
                                onclick="toggleSolution()"
                                class="w-full px-4 py-3 bg-solution-green text-white font-bold rounded-lg shadow-md hover:bg-solution-green/90 transition duration-200 flex items-center justify-center"
                            >
                                แสดง แนวทางการแก้ไข (สำหรับผู้ฝึกสอน) 
                            </button>
                            <div id="solution-content" class="solution-content bg-solution-green/5 border border-solution-green/20 rounded-lg mt-3">
                                <p class="font-bold text-solution-green mb-2 text-lg border-b border-solution-green/20 pb-2">แนวทางการแก้ไขที่ถูกต้อง:</p>
                                <p class="text-gray-800">${scenarioData.solutionKeyActions.replace(/\n/g, '<br>')}</p>
                            </div>
                        </div>

                    </div>
                `;
                simulationResult.innerHTML = renderHTML;

            } catch (error) {
                simulationResult.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 rounded-lg text-red-700">
                    <strong>เกิดข้อผิดพลาดในการสร้างสถานการณ์:</strong> ไม่สามารถประมวลผลข้อมูลจาก AI ได้ กรุณาลองใหม่อีกครั้ง<br>
                    <small>Error: ${error.message}</small>
                    </div>`;
                console.error("Error in generateSimulationIdea:", error);
            } finally {
                simulationLoading.classList.add('hidden');
                generateScenarioBtn.disabled = false;
                simulationResultContainer.classList.remove('shadow-xl');
                simulationResultContainer.classList.add('shadow-md');
            }
        }

        // --- UI Functions ---
        
        // ฟังก์ชันสำหรับการสลับส่วนเนื้อหา
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            const navLinks = document.querySelectorAll('.nav-link');
            
            // ซ่อนทุกส่วนเนื้อหาและลบคลาส active/bold ออกจากเมนูทั้งหมด
            sections.forEach(section => {
                section.classList.add('hidden');
                section.style.opacity = '0'; // สำหรับ transition
            });

            navLinks.forEach(link => {
                link.classList.remove('font-bold');
            });
            
            // แสดงส่วนเนื้อหาที่ต้องการและเพิ่มคลาส active/bold ให้เมนูที่ถูกเลือก
            const targetSection = document.getElementById(sectionId);
            const targetLink = document.querySelector(`[data-target="${sectionId}"]`);
            
            if (targetSection) {
                // แสดงผลและใช้ setTimeout เพื่อให้เกิด transition สวยงาม
                targetSection.classList.remove('hidden');
                setTimeout(() => {
                    targetSection.style.opacity = '1';
                }, 10);
            }

            if (targetLink) {
                targetLink.classList.add('font-bold');
            }
            
            // ส่วนที่เพิ่มเติม: บังคับให้หน้าเว็บเลื่อนขึ้นไปด้านบนสุด (Scroll to Top)
            window.scrollTo({ 
                top: 0, 
                behavior: 'smooth' // ใช้ 'smooth' เพื่อให้การเลื่อนดูนุ่มนวล
            });
        }


        /**
         * Opens the modal with content corresponding to the detailId.
         * @param {string} detailId - The ID of the detail content to load (e.g., 'intro').
         */
        function openModal(detailId) {
            const contentElement = document.getElementById(`detail-content-${detailId}`);
            if (!contentElement) return;

            // Reset AI Assistant UI
            aiQuestionInput.value = '';
            askAiBtn.disabled = true;
            aiResponseContainer.classList.add('hidden');
            aiLoading.classList.add('hidden');
            aiAnswer.innerHTML = '';
            aiSources.innerHTML = '';
            aiAnswer.classList.remove('p-3');
            
            // Set current topic for AI Grounding
            currentDetailTopic = document.getElementById(`detail-topic-${detailId}`)?.textContent || 'C&I Power Plant Maintenance';
            
            // Listen for input change to enable/disable button
            aiQuestionInput.oninput = () => {
                askAiBtn.disabled = aiQuestionInput.value.trim() === '';
            };


            // 1. Set Title and Content
            // The title is the first h3 element inside the detail content
            const title = contentElement.querySelector('h3').textContent;
            modalTitle.textContent = title;
            
            // Clear existing body content first, then copy children of contentElement, excluding the h3 and span title for clean display.
            modalBody.innerHTML = '';
            Array.from(contentElement.children).forEach(child => {
                const tag = child.tagName.toLowerCase();
                if (tag !== 'h3' && tag !== 'span') {
                    modalBody.appendChild(child.cloneNode(true));
                }
            });
            
            // 2. Show Modal
            modal.classList.remove('hidden');
            modalBackdrop.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // ป้องกันการ scroll ของ body

            // 3. Apply transition effects
            // Use a short delay to ensure display: block is processed before transition
            setTimeout(() => {
                modalBackdrop.style.opacity = '1';
                modalContentBox.classList.remove('scale-95', 'opacity-0');
                modalContentBox.classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        /**
         * Closes the modal and resets visibility/transitions.
         */
        function closeModal() {
            modalBackdrop.style.opacity = '0';
            modalContentBox.classList.remove('scale-100', 'opacity-100');
            modalContentBox.classList.add('scale-95', 'opacity-0');
            
            // Wait for transition to finish before hiding
            setTimeout(() => {
                modal.classList.add('hidden');
                modalBackdrop.classList.add('hidden');
                document.body.style.overflow = ''; // คืนค่าการ scroll ของ body
            }, 300);
        }


        document.addEventListener('DOMContentLoaded', () => {
            const detailCards = document.querySelectorAll('.detail-card');
            const navLinks = document.querySelectorAll('.nav-link');
            
            // ตั้งค่าการแสดงผลเริ่มต้น: โหลดส่วน 'overview' เมื่อหน้าเว็บเปิดขึ้น
            showSection('overview');

            // 1. Event Listener สำหรับ Detail Cards เพื่อเปิด Modal
            detailCards.forEach(card => {
                card.addEventListener('click', () => {
                    const detailId = card.dataset.detail;
                    openModal(detailId);
                });
            });
            
            // 2. Event Listener สำหรับ Menu Links เพื่อสลับส่วนเนื้อหา
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // ป้องกันการทำงานของ anchor link ตามปกติ
                    e.preventDefault(); 
                    const sectionId = link.getAttribute('data-target');
                    showSection(sectionId);
                });
            });


            // 3. Event Listener สำหรับ Modal Backdrop เพื่อให้คลิกนอก Modal แล้วปิดได้
            modalBackdrop.addEventListener('click', closeModal);
            
            // 4. ปิด Modal ด้วยปุ่ม Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    closeModal();
                }
            });
        });
    </script>

</body>
</html>
